{"version":3,"file":"vendorProducts-D_vxoRWk.js","sources":["../../server/routes/vendorProducts.ts"],"sourcesContent":["import express from \"express\";\nimport multer from \"multer\";\nimport { createClient } from \"@supabase/supabase-js\";\n\nconst router = express.Router();\n// configure multer with memory storage and allow configurable file size limits\nconst maxFileSize = Number(process.env.UPLOAD_MAX_FILE_SIZE || 5 * 1024 * 1024); // default 5 MB\nconst upload = multer({ storage: multer.memoryStorage(), limits: { fileSize: maxFileSize } });\n\nconst SUPABASE_URL = process.env.SUPABASE_URL || \"\";\nconst SUPABASE_SERVICE_ROLE = process.env.SUPABASE_SERVICE_ROLE || \"\";\n\nif (!SUPABASE_URL || !SUPABASE_SERVICE_ROLE) {\n  console.warn(\n    \"Supabase service role or URL not set. Vendor products route will fail if used.\",\n  );\n}\n\nconst supabaseAdmin = createClient(SUPABASE_URL, SUPABASE_SERVICE_ROLE, {\n  auth: { persistSession: false },\n});\n\n// GET /api/vendor/products?email=vendor@example.com\nrouter.get(\"/products\", async (req, res) => {\n  try {\n    const email = req.query.email as string | undefined;\n    let query = supabaseAdmin\n      .from(\"products\")\n      .select(\"*\")\n      .order(\"id\", { ascending: false })\n      .limit(100);\n    if (email) {\n      query = supabaseAdmin\n        .from(\"products\")\n        .select(\"*\")\n        .eq(\"vendor_email\", email)\n        .order(\"id\", { ascending: false });\n    }\n    const { data, error } = await query;\n    if (error) {\n      console.error(\"Supabase fetch error:\", error);\n      return res\n        .status(500)\n        .json({ message: \"Failed to fetch products\", detail: error });\n    }\n    return res.json({ products: data });\n  } catch (err) {\n    console.error(err);\n    return res.status(500).json({ message: \"Unexpected server error\" });\n  }\n});\n\n// POST /api/vendor/products/upload-image - multipart images upload\nrouter.post(\n  \"/products/upload-image\",\n  upload.array(\"images\"),\n  async (req: any, res) => {\n    try {\n      const files = req.files as Express.Multer.File[] | undefined;\n      const vendor_email = req.body.vendor_email as string | undefined;\n      if (!files || files.length === 0) {\n        return res.status(400).json({ message: \"No files uploaded\" });\n      }\n      const bucket = \"product-images\";\n      const urls: string[] = [];\n      // add vendor folder for better organization if provided\n      const vendorFolder = vendor_email ? `${vendor_email.replace(/[^a-z0-9-_\\.]/gi, \"_\")}` : \"anonymous\";\n      for (const file of files) {\n        const filePath = `${vendorFolder}/${Date.now()}_${file.originalname}`;\n        const { error: uploadError } = await supabaseAdmin.storage\n          .from(bucket)\n          .upload(filePath, file.buffer, {\n            contentType: file.mimetype,\n            upsert: false,\n          });\n        if (uploadError) {\n          console.error(\"Upload error:\", uploadError);\n          continue;\n        }\n        const { data: publicData, error: publicErr } = supabaseAdmin.storage\n          .from(bucket)\n          .getPublicUrl(filePath);\n        if (publicErr) {\n          console.warn(\"getPublicUrl error\", publicErr);\n        }\n        const publicUrl = publicData?.publicUrl ?? null;\n        if (publicUrl) urls.push(publicUrl);\n      }\n      return res.json({ urls });\n    } catch (err) {\n      console.error(err);\n      return res.status(500).json({ message: \"Upload failed\" });\n    }\n  },\n);\n\n// POST /api/vendor/products - create product (supports images, categories, tags, low_stock_threshold)\nrouter.post(\"/products\", async (req, res) => {\n  try {\n    // Accept either vendor_email (common in this project) or vendor_id (if your schema uses that)\n    const {\n      vendor_email,\n      vendor_id,\n      title,\n      description,\n      price,\n      stock,\n      status,\n      images,\n      categories,\n      tags,\n      low_stock_threshold,\n    } = req.body as any;\n\n    if ((!vendor_email && !vendor_id) || !title)\n      return res.status(400).json({ message: \"vendor_email/vendor_id and title are required\" });\n\n    // Normalize categories/tags if provided as comma-separated strings\n    const normalizeArrayField = (v: any) => {\n      if (v == null) return null;\n      if (Array.isArray(v)) return v.filter(Boolean);\n      if (typeof v === \"string\") return v.split(\",\").map((s) => s.trim()).filter(Boolean);\n      return null;\n    };\n\n    const payload: any = {\n      // store whichever vendor identifier the client provided; keep both null if not provided\n      vendor_email: vendor_email || null,\n      vendor_id: vendor_id || null,\n      title,\n      description: description || null,\n      price: price != null ? Number(price) : 0,\n      stock: stock != null ? Number(stock) : 0,\n      // default new vendor-submitted products to pending for review unless explicitly set\n      status: status || \"pending\",\n      images: images || null,\n      categories: normalizeArrayField(categories),\n      tags: normalizeArrayField(tags),\n      low_stock_threshold: low_stock_threshold != null ? Number(low_stock_threshold) : null,\n      created_at: new Date().toISOString(),\n    };\n\n    const { data, error } = await supabaseAdmin\n      .from(\"products\")\n      .insert([payload])\n      .select();\n\n    if (error) {\n      console.error(\"Insert error:\", error);\n      return res.status(500).json({ message: \"Failed to create product\", detail: error });\n    }\n\n    return res.json({ product: data && data[0] });\n  } catch (err: any) {\n    console.error(err);\n    return res.status(500).json({ message: \"Unexpected server error\", detail: err?.message });\n  }\n});\n\n// POST /api/vendor/products/bulk - create many products\nrouter.post(\"/products/bulk\", async (req, res) => {\n  try {\n    const { vendor_email, products } = req.body as any;\n    if (!vendor_email || !Array.isArray(products))\n      return res.status(400).json({ message: \"vendor_email and products array required\" });\n    const payloads = products.map((p: any) => ({\n      vendor_email,\n      title: p.title,\n      description: p.description || null,\n      price: p.price ?? 0,\n      stock: p.stock ?? 0,\n      status: p.status || \"draft\",\n      images: p.images || null,\n      categories: p.categories || null,\n      tags: p.tags || null,\n      low_stock_threshold: p.low_stock_threshold ?? null,\n      created_at: new Date().toISOString(),\n    }));\n    const { data, error } = await supabaseAdmin.from(\"products\").insert(payloads).select();\n    if (error) {\n      console.error(\"Bulk insert error:\", error);\n      return res.status(500).json({ message: \"Failed to insert products\", detail: error });\n    }\n    return res.json({ products: data });\n  } catch (err) {\n    console.error(err);\n    return res.status(500).json({ message: \"Unexpected server error\" });\n  }\n});\n\n// PATCH /api/vendor/products/:id - update product\nrouter.patch(\"/products/:id\", async (req, res) => {\n  try {\n    const id = req.params.id;\n    const updates = req.body;\n    const { data, error } = await supabaseAdmin\n      .from(\"products\")\n      .update(updates)\n      .eq(\"id\", id)\n      .select();\n    if (error) {\n      console.error(\"Update error:\", error);\n      return res\n        .status(500)\n        .json({ message: \"Failed to update product\", detail: error });\n    }\n    return res.json({ product: data && data[0] });\n  } catch (err) {\n    console.error(err);\n    return res.status(500).json({ message: \"Unexpected server error\" });\n  }\n});\n\n// DELETE /api/vendor/products/:id\nrouter.delete(\"/products/:id\", async (req, res) => {\n  try {\n    const id = req.params.id;\n    const { error } = await supabaseAdmin\n      .from(\"products\")\n      .delete()\n      .eq(\"id\", id);\n    if (error) {\n      console.error(\"Delete error:\", error);\n      return res\n        .status(500)\n        .json({ message: \"Failed to delete product\", detail: error });\n    }\n    return res.json({ success: true });\n  } catch (err) {\n    console.error(err);\n    return res.status(500).json({ message: \"Unexpected server error\" });\n  }\n});\n\nexport default router;\n"],"names":["express"],"mappings":"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"}