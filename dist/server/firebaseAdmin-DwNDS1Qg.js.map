{"version":3,"file":"firebaseAdmin-DwNDS1Qg.js","sources":["../../server/firebaseAdmin.ts"],"sourcesContent":["import admin from \"firebase-admin\";\nimport fs from \"fs\";\n\nlet serviceAccount: any = undefined;\nconsole.log(\n  \"SERVER: SERVICE_ACCOUNT_JSON present =\",\n  !!process.env.SERVICE_ACCOUNT_JSON,\n);\n\n// If a URL is provided that returns the service account JSON, fetch it at runtime\n// This allows keeping only a short URL in environment variables (avoids Lambda 4KB limit)\nif (process.env.SERVICE_ACCOUNT_SECRET_URL) {\n  console.log(\"Attempting background fetch of SERVICE_ACCOUNT_SECRET_URL\");\n  // Do not use top-level await â€” fetch in background and apply when ready.\n  fetch(process.env.SERVICE_ACCOUNT_SECRET_URL as string)\n    .then((res) => {\n      if (!res.ok) {\n        console.error(\n          \"Failed to fetch SERVICE_ACCOUNT_SECRET_URL, status:\",\n          res.status,\n          res.statusText,\n        );\n        return null;\n      }\n      return res.text();\n    })\n    .then((text) => {\n      if (!text) return;\n      try {\n        serviceAccount = JSON.parse(text);\n        console.log(\"SERVER: parsed SERVICE_ACCOUNT_SECRET_URL successfully\");\n        // If admin not initialized yet and a serviceAccount is now available, initialize\n        if (!admin.apps.length && serviceAccount) {\n          try {\n            admin.initializeApp({\n              credential: admin.credential.cert(serviceAccount as any),\n            });\n            console.log(\"SERVER: firebase-admin initialized after secret fetch\");\n          } catch (err) {\n            console.error(\"Failed to initialize firebase-admin after fetch:\", err);\n          }\n        }\n      } catch (err) {\n        console.error(\"Failed to parse JSON from SERVICE_ACCOUNT_SECRET_URL response:\", err);\n      }\n    })\n    .catch((err) => {\n      console.error(\"Error fetching SERVICE_ACCOUNT_SECRET_URL:\", err);\n    });\n}\n\n// Support base64-encoded service account JSON for safer env transport\nif (!serviceAccount && process.env.SERVICE_ACCOUNT_JSON_B64) {\n  try {\n    const decoded = Buffer.from(\n      process.env.SERVICE_ACCOUNT_JSON_B64,\n      \"base64\",\n    ).toString(\"utf8\");\n    serviceAccount = JSON.parse(decoded);\n    console.log(\"SERVER: parsed SERVICE_ACCOUNT_JSON_B64 successfully\");\n  } catch (err) {\n    console.error(\"Failed to parse SERVICE_ACCOUNT_JSON_B64:\", err);\n  }\n}\n\nif (!serviceAccount && process.env.SERVICE_ACCOUNT_JSON) {\n  const rawEnv = process.env.SERVICE_ACCOUNT_JSON;\n  try {\n    serviceAccount = JSON.parse(rawEnv);\n  } catch (err) {\n    console.error(\n      \"Failed to parse SERVICE_ACCOUNT_JSON, attempting recovery:\",\n      err,\n    );\n    try {\n      // Try to extract JSON substring between first { and last }\n      const start = rawEnv.indexOf(\"{\");\n      const end = rawEnv.lastIndexOf(\"}\");\n      if (start !== -1 && end !== -1) {\n        let candidate = rawEnv.slice(start, end + 1);\n        // If private_key contains actual newlines, replace them with \\n so JSON is valid\n        candidate = candidate.replace(\n          /\"private_key\"\\s*:\\s*\"([\\s\\S]*?)\"/m,\n          (m, p1) => {\n            const fixed = p1.replace(/\\n/g, \"\\\\n\");\n            return `\"private_key\":\"${fixed}\"`;\n          },\n        );\n        serviceAccount = JSON.parse(candidate);\n      }\n    } catch (err2) {\n      console.error(\"Recovery parse of SERVICE_ACCOUNT_JSON failed:\", err2);\n    }\n  }\n}\n\n// If SERVICE_ACCOUNT_JSON parse failed or wasn't provided, try server/serviceAccountKey.json then root serviceAccountKey.json\nif (!serviceAccount) {\n  try {\n    const raw = fs.readFileSync(\"./server/serviceAccountKey.json\", \"utf-8\");\n    serviceAccount = JSON.parse(raw);\n  } catch (err) {\n    try {\n      const rawRoot = fs.readFileSync(\"./serviceAccountKey.json\", \"utf-8\");\n      serviceAccount = JSON.parse(rawRoot);\n    } catch (err2) {\n      console.warn(\n        \"serviceAccountKey.json not found in server/ or root and SERVICE_ACCOUNT_JSON env var not set or invalid\",\n        err2,\n      );\n    }\n  }\n}\n\nconsole.log(\"SERVER: serviceAccount loaded =\", !!serviceAccount);\n\nif (!admin.apps.length) {\n  if (!serviceAccount) {\n    console.warn(\n      \"No service account available for Firebase Admin initialization\",\n    );\n  }\n\n  try {\n    admin.initializeApp({\n      credential: serviceAccount ? admin.credential.cert(serviceAccount as any) : undefined,\n    });\n  } catch (err) {\n    console.error(\"Failed to initialize firebase-admin:\", err);\n  }\n}\n\nexport default admin;\n"],"names":[],"mappings":"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"}