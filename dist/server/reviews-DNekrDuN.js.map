{"version":3,"file":"reviews-DNekrDuN.js","sources":["../../server/routes/reviews.ts"],"sourcesContent":["import express from \"express\";\nimport { createClient } from \"@supabase/supabase-js\";\nimport admin from \"../firebaseAdmin\";\n\nconst router = express.Router();\n\nconst SUPABASE_URL = process.env.SUPABASE_URL || \"\";\nconst SUPABASE_SERVICE_ROLE = process.env.SUPABASE_SERVICE_ROLE || \"\";\nconst supabaseAdmin = createClient(SUPABASE_URL, SUPABASE_SERVICE_ROLE, {\n  auth: { persistSession: false },\n});\n\n// GET /api/reviews - return public reviews\nrouter.get(\"/\", async (_req, res) => {\n  try {\n    const { data, error } = await supabaseAdmin\n      .from(\"reviews\")\n      .select(\"*\")\n      .not(\"user_name\", \"is\", null)\n      .order(\"created_at\", { ascending: false });\n    if (error) return res.status(500).json({ error: error.message });\n\n    // Attach product metadata (title, images) to each review so clients can render thumbnails.\n    const reviews = data || [];\n    const ids = Array.from(new Set((reviews || []).map((r: any) => r.product_id).filter(Boolean)));\n    if (ids.length === 0) return res.json(reviews);\n\n    try {\n      const { data: products } = await supabaseAdmin\n        .from(\"products\")\n        .select(\"id, title, images\")\n        .in(\"id\", ids as any[]);\n\n      const encodePath = (p: string) => (p || \"\").split(\"/\").map(encodeURIComponent).join(\"/\");\n      const toPublicUrl = (key: string) => {\n        if (!key) return key;\n        const trimmed = String(key).trim();\n        if (!trimmed) return trimmed;\n        if (/^https?:\\/\\//i.test(trimmed) || trimmed.includes(\"/storage/v1/object/public/\")) return trimmed;\n        const base = SUPABASE_URL.replace(/\\/$/, \"\");\n        return `${base}/storage/v1/object/public/product-images/${encodePath(trimmed)}`;\n      };\n\n      const byId: Record<string, any> = {};\n      for (const p of (products || [])) {\n        let imgs: string[] = [];\n        if (Array.isArray(p.images)) imgs = p.images.map((i: any) => toPublicUrl(i));\n        else if (typeof p.images === \"string\") {\n          try {\n            const parsed = JSON.parse(p.images);\n            if (Array.isArray(parsed)) imgs = parsed.map((i: any) => toPublicUrl(String(i)));\n            else imgs = [toPublicUrl(p.images)];\n          } catch (e) {\n            imgs = [toPublicUrl(p.images)];\n          }\n        }\n        byId[String(p.id)] = { id: p.id, title: p.title, images: imgs };\n      }\n\n      const withProduct = reviews\n        .map((r: any) => ({\n          ...r,\n          // normalize name for older clients\n          reviewer_name: r.user_name || r.reviewer_name || r.reviewerName || \"\",\n          product: byId[String(r.product_id)] || null,\n        }));\n\n      // Ensure we only return reviews that have an associated user_id and reviewer_name/user_name\n      const filtered = withProduct.filter((rv: any) => (rv.user_id || rv.external_user_id) && rv.reviewer_name);\n      return res.json(filtered);\n    } catch (e) {\n      console.warn(\"Failed to fetch product metadata for reviews\", e);\n      return res.json(reviews);\n    }\n  } catch (e: any) {\n    console.error(\"GET /api/reviews error\", e);\n    res.status(500).json({ error: String(e?.message || e) });\n  }\n});\n\n// POST /api/reviews - create review; expects Authorization: Bearer <Firebase ID token>\nrouter.post(\"/\", async (req, res) => {\n  try {\n    const token = (req.headers.authorization || \"\").replace(/^Bearer\\s+/i, \"\").trim();\n    let uid: string | null = null;\n    let reviewerName = \"\";\n\n    if (!token) {\n      return res.status(401).json({ error: \"Authentication required\" });\n    }\n\n    try {\n      const decoded = await admin.auth().verifyIdToken(token);\n      uid = decoded.uid;\n      try {\n        const user = await admin.auth().getUser(uid);\n        reviewerName = user.displayName || user.email || \"\";\n      } catch (e) {\n        console.warn(\"Failed to fetch firebase user for review\", e);\n      }\n    } catch (e) {\n      console.warn(\"Invalid Firebase token for /api/reviews POST\", e);\n      return res.status(401).json({ error: \"Invalid authentication token\" });\n    }\n\n    const body = req.body || {};\n    if (!body.productId || !body.orderId || typeof body.rating === \"undefined\") {\n      return res.status(400).json({ error: \"productId, orderId and rating required\" });\n    }\n\n    // The public reviews table schema uses user_name (not reviewer_name) and does not include attachments or order_id.\n    const insertRow: any = {\n    // store Firebase uid in external_user_id (text) â€” do NOT set user_id because the column expects a UUID\n    external_user_id: uid,\n    product_id: String(body.productId),\n    user_name: reviewerName || body.reviewerName || \"\",\n    rating: Number(body.rating || 0),\n    comment: body.text || body.comment || \"\",\n  };\n\n    const resp = await supabaseAdmin.from(\"reviews\").insert([insertRow]);\n    if ((resp as any).error) {\n      console.error(\"Supabase insert error:\", (resp as any).error);\n      return res.status(500).json({ error: (resp as any).error.message || resp });\n    }\n\n    const inserted = (resp as any).data && (resp as any).data[0];\n    res.status(201).json(inserted || null);\n  } catch (e: any) {\n    console.error(\"POST /api/reviews error\", e);\n    res.status(500).json({ error: String(e?.message || e) });\n  }\n});\n\nexport default router;\n"],"names":["express"],"mappings":"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"}