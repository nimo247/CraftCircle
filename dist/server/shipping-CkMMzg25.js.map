{"version":3,"file":"shipping-CkMMzg25.js","sources":["../../server/routes/shipping.ts"],"sourcesContent":["import express from \"express\";\nimport crypto from \"crypto\";\n\nconst router = express.Router();\n\nfunction easyshipHeaders(key: string | undefined) {\n  return {\n    \"Content-Type\": \"application/json\",\n    Authorization: `Bearer ${key}`,\n  };\n}\n\nfunction getProvider() {\n  return (\n    process.env.SHIPPING_PROVIDER ||\n    (process.env.EASYSHIP_API_KEY ? \"easyship\" : \"\")\n  );\n}\n\n// POST /api/shipping/estimate\n// Accepts either full origin/destination/parcels or a simple { to_pincode, weight }\nrouter.post(\"/estimate\", async (req, res) => {\n  const PROVIDER = getProvider();\n  const EASYSHIP_BASE = process.env.EASYSHIP_BASE_URL;\n  const EASYSHIP_KEY = process.env.EASYSHIP_API_KEY;\n\n  // If hardcoded mode enabled, return random fares per-item\n  const HARDCODE =\n    (\n      process.env.SHIPPING_HARDCODE ||\n      process.env.SHIPPING_HARDCODED ||\n      \"\"\n    ).toLowerCase() === \"true\" || (process.env.SHIPPING_HARDCODE || \"\") === \"1\";\n\n  // Allow simple payloads from client: { to_pincode, weight }\n  const body = req.body || {};\n  const { origin, destination, parcels, items } = body;\n\n  // Validate postal code when provided as simple to_pincode/pincode/postalCode\n  const rawPincode =\n    body.to_pincode || body.pincode || body.postalCode || body.postal_code;\n  if (!origin && !destination && rawPincode) {\n    const pc = String(rawPincode).trim();\n    if (!/^\\d{6}$/.test(pc)) {\n      return res\n        .status(400)\n        .json({\n          error: \"invalid_postal_code\",\n          message: \"Postal code must be exactly 6 digits (0-9)\",\n        });\n    }\n  }\n\n  if (HARDCODE) {\n    // Build items array from various possible fields\n    const srcItems =\n      Array.isArray(items) && items.length > 0\n        ? items\n        : Array.isArray(parcels) && parcels.length > 0\n          ? parcels.map((p: any, idx: number) => ({\n              id: p.productId || p.sku || `parcel_${idx}`,\n              weight: p.actual_weight || p.weight || 0.5,\n            }))\n          : // fallback single item\n            [\n              {\n                id: body.productId || body.sku || \"default\",\n                weight: Number(body.weight || 0.5),\n              },\n            ];\n\n    const currency = process.env.SHIPPING_CURRENCY || \"INR\";\n\n    // deterministic seeded fare generator using sha256\n    const salt = process.env.SHIPPING_HARDCODE_SALT || \"\";\n    function seededFare(seed: string, min = 20, max = 200) {\n      try {\n        const h = crypto\n          .createHash(\"sha256\")\n          .update(String(seed) + salt)\n          .digest();\n        const v = h.readUInt32BE(0);\n        const t = v / 0xffffffff;\n        const fare = min + t * (max - min);\n        return Math.round(fare * 100) / 100;\n      } catch (e) {\n        // fallback\n        return Math.round((Math.random() * (max - min) + min) * 100) / 100;\n      }\n    }\n\n    const rates = srcItems.map((it: any, idx: number) => {\n      const idStr = String(it.id || it.sku || `item_${idx}`);\n      const fare = seededFare(idStr);\n      return {\n        productId: idStr,\n        weight: it.weight || null,\n        currency,\n        shipping_cost: fare,\n        label: `Hardcoded seeded rate for ${idStr}`,\n      };\n    });\n\n    return res.json({\n      generatedAt: Date.now(),\n      hardcoded: true,\n      seed: process.env.SHIPPING_HARDCODE_SALT || null,\n      rates,\n    });\n  }\n\n  if (PROVIDER !== \"easyship\") {\n    return res\n      .status(501)\n      .json({ error: \"no_provider\", provider: PROVIDER || null });\n  }\n  if (!EASYSHIP_KEY || !EASYSHIP_BASE) {\n    return res.status(500).json({ error: \"missing_credentials\" });\n  }\n\n  let payloadOrigin = origin;\n  let payloadDestination = destination;\n  let payloadParcels = parcels;\n\n  if (!payloadOrigin || !payloadDestination || !payloadParcels) {\n    // If client provided to_pincode and weight, synthesize full payload\n    const to_pincode =\n      (body.to_pincode ||\n        body.pincode ||\n        body.postalCode ||\n        body.postal_code) &&\n      String(\n        body.to_pincode || body.pincode || body.postalCode || body.postal_code,\n      );\n    const weight = Number(body.weight || body.actual_weight || 0.5) || 0.5;\n    const length = Number(body.length || 10) || 10;\n    const width = Number(body.width || 10) || 10;\n    const height = Number(body.height || 5) || 5;\n\n    if (to_pincode) {\n      // synthesize origin from env or fallback\n      const EASYSHIP_PICKUP =\n        process.env.EASYSHIP_PICKUP_PINCODE ||\n        process.env.SHIPPING_PICKUP_PINCODE ||\n        process.env.SHIPROCKET_PICKUP_PINCODE ||\n        process.env.SHIP_PICKUP_PINCODE ||\n        \"110064\";\n      const pickup_country =\n        process.env.EASYSHIP_PICKUP_COUNTRY ||\n        process.env.SHIPPING_PICKUP_COUNTRY ||\n        \"IN\";\n      const dest_country = body.country_code || body.country || \"IN\";\n\n      // Ensure destination postal code validated as 7 digits (server-side check)\n      if (!/^\\d{6}$/.test(String(to_pincode))) {\n        return res\n          .status(400)\n          .json({\n            error: \"invalid_postal_code\",\n            message: \"Postal code must be exactly 6 digits (0-9)\",\n          });\n      }\n\n      payloadOrigin = payloadOrigin || {\n        postal_code: String(EASYSHIP_PICKUP),\n        country_code: pickup_country,\n      };\n      payloadDestination = payloadDestination || {\n        postal_code: to_pincode,\n        country_code: dest_country,\n      };\n      payloadParcels = payloadParcels || [\n        {\n          actual_weight: weight,\n          length,\n          width,\n          height,\n          items: [\n            {\n              description: body.item_description || \"item\",\n              quantity: Number(body.qty || 1) || 1,\n              value: Number(body.value || 0) || 0,\n            },\n          ],\n        },\n      ];\n    }\n  }\n\n  // final validation\n  if (\n    !payloadOrigin ||\n    !payloadDestination ||\n    !payloadParcels ||\n    payloadParcels.length === 0\n  ) {\n    return res\n      .status(400)\n      .json({\n        error: \"invalid_payload\",\n        message: \"Provide origin/destination/parcels or to_pincode+weight\",\n      });\n  }\n\n  const payload = {\n    origin_address: payloadOrigin,\n    destination_address: payloadDestination,\n    parcels: payloadParcels,\n  };\n\n  try {\n    try {\n      console.log(\"EASYSHIP OUTGOING PAYLOAD:\", JSON.stringify(payload));\n    } catch (_) {}\n    const resp = await fetch(\n      `${EASYSHIP_BASE.replace(/\\/$/, \"\")}/rate/v1/rates`,\n      {\n        method: \"POST\",\n        headers: easyshipHeaders(EASYSHIP_KEY),\n        body: JSON.stringify(payload),\n      },\n    );\n    const text = await resp.text();\n    try {\n      console.log(\"EASYSHIP RESPONSE STATUS:\", resp.status);\n      console.log(\"EASYSHIP RESPONSE BODY:\", text);\n    } catch (_) {}\n    try {\n      const json = JSON.parse(text);\n      return res.status(resp.status).json(json);\n    } catch (_) {\n      return res.status(resp.status).send(text);\n    }\n  } catch (err: any) {\n    console.error(\"Easyship rate error:\", err);\n    return res.status(500).json({ error: String(err?.message || err) });\n  }\n});\n\n// POST /api/shipping/shipment\n// body: { origin, destination, parcel, courier_id, order_id }\nrouter.post(\"/shipment\", async (req, res) => {\n  const PROVIDER = getProvider();\n  const EASYSHIP_BASE = process.env.EASYSHIP_BASE_URL;\n  const EASYSHIP_KEY = process.env.EASYSHIP_API_KEY;\n\n  if (PROVIDER !== \"easyship\") {\n    return res\n      .status(501)\n      .json({ error: \"no_provider\", provider: PROVIDER || null });\n  }\n  if (!EASYSHIP_KEY || !EASYSHIP_BASE) {\n    return res.status(500).json({ error: \"missing_credentials\" });\n  }\n\n  const { origin, destination, parcel, courier_id, order_id } = req.body || {};\n\n  const payload: any = {\n    origin_address: origin,\n    destination_address: destination,\n    parcels: Array.isArray(parcel) ? parcel : [parcel],\n    courier_selection: courier_id ? { id: courier_id } : undefined,\n    platform_order_number: order_id,\n  };\n\n  try {\n    const resp = await fetch(\n      `${EASYSHIP_BASE.replace(/\\/$/, \"\")}/shipment/v1/shipments`,\n      {\n        method: \"POST\",\n        headers: easyshipHeaders(EASYSHIP_KEY),\n        body: JSON.stringify(payload),\n      },\n    );\n    const data = await resp.json().catch(() => null);\n    if (data !== null) return res.status(resp.status).json(data);\n    const text = await resp.text();\n    return res.status(resp.status).send(text);\n  } catch (err: any) {\n    console.error(\"Easyship create-shipment error:\", err);\n    return res.status(500).json({ error: String(err?.message || err) });\n  }\n});\n\n// POST /api/shipping/track\n// body: { shipment_id, tracking_number }\nrouter.post(\"/track\", async (req, res) => {\n  const PROVIDER = getProvider();\n  const EASYSHIP_BASE = process.env.EASYSHIP_BASE_URL;\n  const EASYSHIP_KEY = process.env.EASYSHIP_API_KEY;\n\n  if (PROVIDER !== \"easyship\") {\n    return res\n      .status(501)\n      .json({ error: \"no_provider\", provider: PROVIDER || null });\n  }\n  if (!EASYSHIP_KEY || !EASYSHIP_BASE) {\n    return res.status(500).json({ error: \"missing_credentials\" });\n  }\n\n  const { shipment_id, tracking_number } = req.body || {};\n\n  try {\n    if (shipment_id) {\n      // Try a few reasonable endpoints for fetching shipment/tracking\n      const base = EASYSHIP_BASE.replace(/\\/$/, \"\");\n      const tries = [\n        `${base}/shipment/v1/shipments/${encodeURIComponent(shipment_id)}/tracking`,\n        `${base}/shipment/v1/shipments/${encodeURIComponent(shipment_id)}`,\n      ];\n      for (const url of tries) {\n        const resp = await fetch(url, {\n          method: \"GET\",\n          headers: easyshipHeaders(EASYSHIP_KEY),\n        });\n        const text = await resp.text();\n        try {\n          const json = JSON.parse(text);\n          return res.status(resp.status).json(json);\n        } catch (_) {\n          // not json, continue to next\n          if (resp.ok) return res.status(resp.status).send(text);\n        }\n      }\n      return res.status(404).json({ error: \"not_found\" });\n    }\n\n    if (tracking_number) {\n      const url = `${EASYSHIP_BASE.replace(/\\/$/, \"\")}/tracking/v1/trackings/${encodeURIComponent(tracking_number)}`;\n      const resp = await fetch(url, {\n        method: \"GET\",\n        headers: easyshipHeaders(EASYSHIP_KEY),\n      });\n      const data = await resp.json().catch(() => null);\n      if (data !== null) return res.status(resp.status).json(data);\n      const text = await resp.text();\n      return res.status(resp.status).send(text);\n    }\n\n    return res\n      .status(400)\n      .json({\n        error: \"missing_parameters\",\n        message: \"Provide shipment_id or tracking_number in body\",\n      });\n  } catch (err: any) {\n    console.error(\"Easyship track error:\", err);\n    return res.status(500).json({ error: String(err?.message || err) });\n  }\n});\n\n// GET /api/shipping/debug\nrouter.get(\"/debug\", (_req, res) => {\n  res.json({\n    configured: Boolean(PROVIDER),\n    provider: PROVIDER || null,\n    easyship: { base: Boolean(EASYSHIP_BASE), key: Boolean(EASYSHIP_KEY) },\n  });\n});\n\nexport default router;\n"],"names":["express","PROVIDER","EASYSHIP_BASE","EASYSHIP_KEY"],"mappings":";;AAGA,MAAM,SAASA,iBAAQ,OAAA;AAEvB,SAAS,gBAAgB,KAAyB;AAChD,SAAO;AAAA,IACL,gBAAgB;AAAA,IAChB,eAAe,UAAU,GAAG;AAAA,EAAA;AAEhC;AAEA,SAAS,cAAc;AACrB,SACE,QAAQ,IAAI,sBACX,QAAQ,IAAI,mBAAmB,aAAa;AAEjD;AAIA,OAAO,KAAK,aAAa,OAAO,KAAK,QAAQ;AAC3C,QAAMC,YAAW,YAAA;AACjB,QAAMC,iBAAgB,QAAQ,IAAI;AAClC,QAAMC,gBAAe,QAAQ,IAAI;AAGjC,QAAM,YAEF,QAAQ,IAAI,qBACZ,QAAQ,IAAI,sBACZ,IACA,YAAA,MAAkB,WAAW,QAAQ,IAAI,qBAAqB,QAAQ;AAG1E,QAAM,OAAO,IAAI,QAAQ,CAAA;AACzB,QAAM,EAAE,QAAQ,aAAa,SAAS,UAAU;AAGhD,QAAM,aACJ,KAAK,cAAc,KAAK,WAAW,KAAK,cAAc,KAAK;AAC7D,MAAI,CAAC,UAAU,CAAC,eAAe,YAAY;AACzC,UAAM,KAAK,OAAO,UAAU,EAAE,KAAA;AAC9B,QAAI,CAAC,UAAU,KAAK,EAAE,GAAG;AACvB,aAAO,IACJ,OAAO,GAAG,EACV,KAAK;AAAA,QACJ,OAAO;AAAA,QACP,SAAS;AAAA,MAAA,CACV;AAAA,IACL;AAAA,EACF;AAEA,MAAI,UAAU;AAsBZ,QAAS,aAAT,SAAoB,MAAc,MAAM,IAAI,MAAM,KAAK;AACrD,UAAI;AACF,cAAM,IAAI,OACP,WAAW,QAAQ,EACnB,OAAO,OAAO,IAAI,IAAI,IAAI,EAC1B,OAAA;AACH,cAAM,IAAI,EAAE,aAAa,CAAC;AAC1B,cAAM,IAAI,IAAI;AACd,cAAM,OAAO,MAAM,KAAK,MAAM;AAC9B,eAAO,KAAK,MAAM,OAAO,GAAG,IAAI;AAAA,MAClC,SAAS,GAAG;AAEV,eAAO,KAAK,OAAO,KAAK,OAAA,KAAY,MAAM,OAAO,OAAO,GAAG,IAAI;AAAA,MACjE;AAAA,IACF;AAlCA,UAAM,WACJ,MAAM,QAAQ,KAAK,KAAK,MAAM,SAAS,IACnC,QACA,MAAM,QAAQ,OAAO,KAAK,QAAQ,SAAS,IACzC,QAAQ,IAAI,CAAC,GAAQ,SAAiB;AAAA,MACpC,IAAI,EAAE,aAAa,EAAE,OAAO,UAAU,GAAG;AAAA,MACzC,QAAQ,EAAE,iBAAiB,EAAE,UAAU;AAAA,IAAA,EACvC;AAAA;AAAA,MAEF;AAAA,QACE;AAAA,UACE,IAAI,KAAK,aAAa,KAAK,OAAO;AAAA,UAClC,QAAQ,OAAO,KAAK,UAAU,GAAG;AAAA,QAAA;AAAA,MACnC;AAAA;AAGV,UAAM,WAAW,QAAQ,IAAI,qBAAqB;AAGlD,UAAM,OAAO,QAAQ,IAAI,0BAA0B;AAiBnD,UAAM,QAAQ,SAAS,IAAI,CAAC,IAAS,QAAgB;AACnD,YAAM,QAAQ,OAAO,GAAG,MAAM,GAAG,OAAO,QAAQ,GAAG,EAAE;AACrD,YAAM,OAAO,WAAW,KAAK;AAC7B,aAAO;AAAA,QACL,WAAW;AAAA,QACX,QAAQ,GAAG,UAAU;AAAA,QACrB;AAAA,QACA,eAAe;AAAA,QACf,OAAO,6BAA6B,KAAK;AAAA,MAAA;AAAA,IAE7C,CAAC;AAED,WAAO,IAAI,KAAK;AAAA,MACd,aAAa,KAAK,IAAA;AAAA,MAClB,WAAW;AAAA,MACX,MAAM,QAAQ,IAAI,0BAA0B;AAAA,MAC5C;AAAA,IAAA,CACD;AAAA,EACH;AAEA,MAAIF,cAAa,YAAY;AAC3B,WAAO,IACJ,OAAO,GAAG,EACV,KAAK,EAAE,OAAO,eAAe,UAAUA,aAAY,KAAA,CAAM;AAAA,EAC9D;AACA,MAAI,CAACE,iBAAgB,CAACD,gBAAe;AACnC,WAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,uBAAuB;AAAA,EAC9D;AAEA,MAAI,gBAAgB;AACpB,MAAI,qBAAqB;AACzB,MAAI,iBAAiB;AAErB,MAAI,CAAC,iBAAiB,CAAC,sBAAsB,CAAC,gBAAgB;AAE5D,UAAM,cACH,KAAK,cACJ,KAAK,WACL,KAAK,cACL,KAAK,gBACP;AAAA,MACE,KAAK,cAAc,KAAK,WAAW,KAAK,cAAc,KAAK;AAAA,IAAA;AAE/D,UAAM,SAAS,OAAO,KAAK,UAAU,KAAK,iBAAiB,GAAG,KAAK;AACnE,UAAM,SAAS,OAAO,KAAK,UAAU,EAAE,KAAK;AAC5C,UAAM,QAAQ,OAAO,KAAK,SAAS,EAAE,KAAK;AAC1C,UAAM,SAAS,OAAO,KAAK,UAAU,CAAC,KAAK;AAE3C,QAAI,YAAY;AAEd,YAAM,kBACJ,QAAQ,IAAI,2BACZ,QAAQ,IAAI,2BACZ,QAAQ,IAAI,6BACZ,QAAQ,IAAI,uBACZ;AACF,YAAM,iBACJ,QAAQ,IAAI,2BACZ,QAAQ,IAAI,2BACZ;AACF,YAAM,eAAe,KAAK,gBAAgB,KAAK,WAAW;AAG1D,UAAI,CAAC,UAAU,KAAK,OAAO,UAAU,CAAC,GAAG;AACvC,eAAO,IACJ,OAAO,GAAG,EACV,KAAK;AAAA,UACJ,OAAO;AAAA,UACP,SAAS;AAAA,QAAA,CACV;AAAA,MACL;AAEA,sBAAgB,iBAAiB;AAAA,QAC/B,aAAa,OAAO,eAAe;AAAA,QACnC,cAAc;AAAA,MAAA;AAEhB,2BAAqB,sBAAsB;AAAA,QACzC,aAAa;AAAA,QACb,cAAc;AAAA,MAAA;AAEhB,uBAAiB,kBAAkB;AAAA,QACjC;AAAA,UACE,eAAe;AAAA,UACf;AAAA,UACA;AAAA,UACA;AAAA,UACA,OAAO;AAAA,YACL;AAAA,cACE,aAAa,KAAK,oBAAoB;AAAA,cACtC,UAAU,OAAO,KAAK,OAAO,CAAC,KAAK;AAAA,cACnC,OAAO,OAAO,KAAK,SAAS,CAAC,KAAK;AAAA,YAAA;AAAA,UACpC;AAAA,QACF;AAAA,MACF;AAAA,IAEJ;AAAA,EACF;AAGA,MACE,CAAC,iBACD,CAAC,sBACD,CAAC,kBACD,eAAe,WAAW,GAC1B;AACA,WAAO,IACJ,OAAO,GAAG,EACV,KAAK;AAAA,MACJ,OAAO;AAAA,MACP,SAAS;AAAA,IAAA,CACV;AAAA,EACL;AAEA,QAAM,UAAU;AAAA,IACd,gBAAgB;AAAA,IAChB,qBAAqB;AAAA,IACrB,SAAS;AAAA,EAAA;AAGX,MAAI;AACF,QAAI;AACF,cAAQ,IAAI,8BAA8B,KAAK,UAAU,OAAO,CAAC;AAAA,IACnE,SAAS,GAAG;AAAA,IAAC;AACb,UAAM,OAAO,MAAM;AAAA,MACjB,GAAGA,eAAc,QAAQ,OAAO,EAAE,CAAC;AAAA,MACnC;AAAA,QACE,QAAQ;AAAA,QACR,SAAS,gBAAgBC,aAAY;AAAA,QACrC,MAAM,KAAK,UAAU,OAAO;AAAA,MAAA;AAAA,IAC9B;AAEF,UAAM,OAAO,MAAM,KAAK,KAAA;AACxB,QAAI;AACF,cAAQ,IAAI,6BAA6B,KAAK,MAAM;AACpD,cAAQ,IAAI,2BAA2B,IAAI;AAAA,IAC7C,SAAS,GAAG;AAAA,IAAC;AACb,QAAI;AACF,YAAM,OAAO,KAAK,MAAM,IAAI;AAC5B,aAAO,IAAI,OAAO,KAAK,MAAM,EAAE,KAAK,IAAI;AAAA,IAC1C,SAAS,GAAG;AACV,aAAO,IAAI,OAAO,KAAK,MAAM,EAAE,KAAK,IAAI;AAAA,IAC1C;AAAA,EACF,SAAS,KAAU;AACjB,YAAQ,MAAM,wBAAwB,GAAG;AACzC,WAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,OAAO,KAAK,WAAW,GAAG,EAAA,CAAG;AAAA,EACpE;AACF,CAAC;AAID,OAAO,KAAK,aAAa,OAAO,KAAK,QAAQ;AAC3C,QAAMF,YAAW,YAAA;AACjB,QAAMC,iBAAgB,QAAQ,IAAI;AAClC,QAAMC,gBAAe,QAAQ,IAAI;AAEjC,MAAIF,cAAa,YAAY;AAC3B,WAAO,IACJ,OAAO,GAAG,EACV,KAAK,EAAE,OAAO,eAAe,UAAUA,aAAY,KAAA,CAAM;AAAA,EAC9D;AACA,MAAI,CAACE,iBAAgB,CAACD,gBAAe;AACnC,WAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,uBAAuB;AAAA,EAC9D;AAEA,QAAM,EAAE,QAAQ,aAAa,QAAQ,YAAY,SAAA,IAAa,IAAI,QAAQ,CAAA;AAE1E,QAAM,UAAe;AAAA,IACnB,gBAAgB;AAAA,IAChB,qBAAqB;AAAA,IACrB,SAAS,MAAM,QAAQ,MAAM,IAAI,SAAS,CAAC,MAAM;AAAA,IACjD,mBAAmB,aAAa,EAAE,IAAI,eAAe;AAAA,IACrD,uBAAuB;AAAA,EAAA;AAGzB,MAAI;AACF,UAAM,OAAO,MAAM;AAAA,MACjB,GAAGA,eAAc,QAAQ,OAAO,EAAE,CAAC;AAAA,MACnC;AAAA,QACE,QAAQ;AAAA,QACR,SAAS,gBAAgBC,aAAY;AAAA,QACrC,MAAM,KAAK,UAAU,OAAO;AAAA,MAAA;AAAA,IAC9B;AAEF,UAAM,OAAO,MAAM,KAAK,OAAO,MAAM,MAAM,IAAI;AAC/C,QAAI,SAAS,KAAM,QAAO,IAAI,OAAO,KAAK,MAAM,EAAE,KAAK,IAAI;AAC3D,UAAM,OAAO,MAAM,KAAK,KAAA;AACxB,WAAO,IAAI,OAAO,KAAK,MAAM,EAAE,KAAK,IAAI;AAAA,EAC1C,SAAS,KAAU;AACjB,YAAQ,MAAM,mCAAmC,GAAG;AACpD,WAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,OAAO,KAAK,WAAW,GAAG,EAAA,CAAG;AAAA,EACpE;AACF,CAAC;AAID,OAAO,KAAK,UAAU,OAAO,KAAK,QAAQ;AACxC,QAAMF,YAAW,YAAA;AACjB,QAAMC,iBAAgB,QAAQ,IAAI;AAClC,QAAMC,gBAAe,QAAQ,IAAI;AAEjC,MAAIF,cAAa,YAAY;AAC3B,WAAO,IACJ,OAAO,GAAG,EACV,KAAK,EAAE,OAAO,eAAe,UAAUA,aAAY,KAAA,CAAM;AAAA,EAC9D;AACA,MAAI,CAACE,iBAAgB,CAACD,gBAAe;AACnC,WAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,uBAAuB;AAAA,EAC9D;AAEA,QAAM,EAAE,aAAa,gBAAA,IAAoB,IAAI,QAAQ,CAAA;AAErD,MAAI;AACF,QAAI,aAAa;AAEf,YAAM,OAAOA,eAAc,QAAQ,OAAO,EAAE;AAC5C,YAAM,QAAQ;AAAA,QACZ,GAAG,IAAI,0BAA0B,mBAAmB,WAAW,CAAC;AAAA,QAChE,GAAG,IAAI,0BAA0B,mBAAmB,WAAW,CAAC;AAAA,MAAA;AAElE,iBAAW,OAAO,OAAO;AACvB,cAAM,OAAO,MAAM,MAAM,KAAK;AAAA,UAC5B,QAAQ;AAAA,UACR,SAAS,gBAAgBC,aAAY;AAAA,QAAA,CACtC;AACD,cAAM,OAAO,MAAM,KAAK,KAAA;AACxB,YAAI;AACF,gBAAM,OAAO,KAAK,MAAM,IAAI;AAC5B,iBAAO,IAAI,OAAO,KAAK,MAAM,EAAE,KAAK,IAAI;AAAA,QAC1C,SAAS,GAAG;AAEV,cAAI,KAAK,GAAI,QAAO,IAAI,OAAO,KAAK,MAAM,EAAE,KAAK,IAAI;AAAA,QACvD;AAAA,MACF;AACA,aAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,aAAa;AAAA,IACpD;AAEA,QAAI,iBAAiB;AACnB,YAAM,MAAM,GAAGD,eAAc,QAAQ,OAAO,EAAE,CAAC,0BAA0B,mBAAmB,eAAe,CAAC;AAC5G,YAAM,OAAO,MAAM,MAAM,KAAK;AAAA,QAC5B,QAAQ;AAAA,QACR,SAAS,gBAAgBC,aAAY;AAAA,MAAA,CACtC;AACD,YAAM,OAAO,MAAM,KAAK,OAAO,MAAM,MAAM,IAAI;AAC/C,UAAI,SAAS,KAAM,QAAO,IAAI,OAAO,KAAK,MAAM,EAAE,KAAK,IAAI;AAC3D,YAAM,OAAO,MAAM,KAAK,KAAA;AACxB,aAAO,IAAI,OAAO,KAAK,MAAM,EAAE,KAAK,IAAI;AAAA,IAC1C;AAEA,WAAO,IACJ,OAAO,GAAG,EACV,KAAK;AAAA,MACJ,OAAO;AAAA,MACP,SAAS;AAAA,IAAA,CACV;AAAA,EACL,SAAS,KAAU;AACjB,YAAQ,MAAM,yBAAyB,GAAG;AAC1C,WAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,OAAO,KAAK,WAAW,GAAG,EAAA,CAAG;AAAA,EACpE;AACF,CAAC;AAGD,OAAO,IAAI,UAAU,CAAC,MAAM,QAAQ;AAClC,MAAI,KAAK;AAAA,IACP,YAAY,QAAQ,QAAQ;AAAA,IAC5B,UAAU,YAAY;AAAA,IACtB,UAAU,EAAE,MAAM,QAAQ,aAAa,GAAG,KAAK,QAAQ,YAAY,EAAA;AAAA,EAAE,CACtE;AACH,CAAC;"}