{"version":3,"file":"vendor-Dh9YR0ZK.js","sources":["../../server/routes/vendor.ts"],"sourcesContent":["import express from \"express\";\nimport multer from \"multer\";\nimport { createClient } from \"@supabase/supabase-js\";\n\nconst router = express.Router();\nconst upload = multer({ storage: multer.memoryStorage() });\n\nconst SUPABASE_URL = process.env.SUPABASE_URL || \"\";\nconst SUPABASE_SERVICE_ROLE = process.env.SUPABASE_SERVICE_ROLE || \"\";\n\nif (!SUPABASE_URL || !SUPABASE_SERVICE_ROLE) {\n  console.warn(\"Supabase service role or URL not set. Vendor upload route will fail if used.\");\n}\n\nconst supabaseAdmin = createClient(SUPABASE_URL, SUPABASE_SERVICE_ROLE, {\n  auth: { persistSession: false },\n});\n\n// POST /api/vendor/apply\n// Expects multipart/form-data with fields: business_name, contact_email, primary_category, location, your_story, sustainability_practices (JSON array or comma separated), and file field 'document'\nrouter.post(\"/apply\", upload.single(\"document\"), async (req, res) => {\n  try {\n    const file = req.file as Express.Multer.File | undefined;\n    const {\n      business_name,\n      contact_email,\n      primary_category,\n      location,\n      your_story,\n      sustainability_practices,\n    } = req.body as Record<string, any>;\n\n    if (!file) return res.status(400).json({ message: \"No file uploaded\" });\n\n    // Validate PDF\n    if (file.mimetype !== \"application/pdf\" && !file.originalname.toLowerCase().endsWith(\".pdf\")) {\n      return res.status(400).json({ message: \"Only PDF files are allowed\" });\n    }\n\n    const bucket = \"vendor-documents\";\n    const filePath = `vendor_docs/${Date.now()}_${file.originalname}`;\n\n    // Upload using service role key\n    const { error: uploadError } = await supabaseAdmin.storage\n      .from(bucket)\n      .upload(filePath, file.buffer, {\n        contentType: file.mimetype,\n        upsert: false,\n      });\n\n    if (uploadError) {\n      console.error(\"Supabase upload error:\", uploadError);\n      return res.status(500).json({ message: \"File upload failed\", detail: uploadError });\n    }\n\n    const { data: publicData, error: publicErr } = supabaseAdmin.storage.from(bucket).getPublicUrl(filePath);\n    if (publicErr) {\n      console.warn(\"getPublicUrl error\", publicErr);\n    }\n    const publicUrl = publicData?.publicUrl ?? null;\n\n    const practices =\n      typeof sustainability_practices === \"string\"\n        ? (sustainability_practices?.startsWith(\"[\") ? JSON.parse(sustainability_practices) : sustainability_practices.split(\",\").map((s: string) => s.trim()))\n        : sustainability_practices || [];\n\n    // Normalize primary_category to values expected by the DB\n    const categoryMap: Record<string, string> = {\n      home: \"Home & Living\",\n      fashion: \"Fashion & Accessories\",\n      art: \"Art & Collectibles\",\n      wellness: \"Wellness\",\n    };\n    const normalizedCategory = categoryMap[primary_category] || primary_category;\n\n    const { error: insertError } = await supabaseAdmin.from(\"vendors\").insert([\n      {\n        business_name,\n        contact_email,\n        primary_category: normalizedCategory,\n        location,\n        your_story,\n        sustainability_practices: practices,\n        verification_document_url: publicUrl,\n        status: \"pending\",\n      },\n    ]);\n\n    if (insertError) {\n      console.error(\"Insert error:\", insertError);\n      return res.status(500).json({ message: \"Failed to save vendor application\", detail: insertError });\n    }\n\n    return res.json({ message: \"Application submitted\", status: \"pending\" });\n  } catch (err) {\n    console.error(err);\n    return res.status(500).json({ message: \"Unexpected server error\" });\n  }\n});\n\nexport default router;\n"],"names":["express"],"mappings":";;;AAIA,MAAM,SAASA,iBAAQ,OAAA;AACvB,MAAM,SAAS,OAAO,EAAE,SAAS,OAAO,cAAA,GAAiB;AAEzD,MAAM,eAAe,QAAQ,IAAI,gBAAgB;AACjD,MAAM,wBAAwB,QAAQ,IAAI,yBAAyB;AAEnE,IAAI,CAAC,gBAAgB,CAAC,uBAAuB;AAC3C,UAAQ,KAAK,8EAA8E;AAC7F;AAEA,MAAM,gBAAgB,aAAa,cAAc,uBAAuB;AAAA,EACtE,MAAM,EAAE,gBAAgB,MAAA;AAC1B,CAAC;AAID,OAAO,KAAK,UAAU,OAAO,OAAO,UAAU,GAAG,OAAO,KAAK,QAAQ;AACnE,MAAI;AACF,UAAM,OAAO,IAAI;AACjB,UAAM;AAAA,MACJ;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,IAAA,IACE,IAAI;AAER,QAAI,CAAC,KAAM,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,SAAS,oBAAoB;AAGtE,QAAI,KAAK,aAAa,qBAAqB,CAAC,KAAK,aAAa,YAAA,EAAc,SAAS,MAAM,GAAG;AAC5F,aAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,SAAS,8BAA8B;AAAA,IACvE;AAEA,UAAM,SAAS;AACf,UAAM,WAAW,eAAe,KAAK,KAAK,IAAI,KAAK,YAAY;AAG/D,UAAM,EAAE,OAAO,gBAAgB,MAAM,cAAc,QAChD,KAAK,MAAM,EACX,OAAO,UAAU,KAAK,QAAQ;AAAA,MAC7B,aAAa,KAAK;AAAA,MAClB,QAAQ;AAAA,IAAA,CACT;AAEH,QAAI,aAAa;AACf,cAAQ,MAAM,0BAA0B,WAAW;AACnD,aAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,SAAS,sBAAsB,QAAQ,aAAa;AAAA,IACpF;AAEA,UAAM,EAAE,MAAM,YAAY,OAAO,UAAA,IAAc,cAAc,QAAQ,KAAK,MAAM,EAAE,aAAa,QAAQ;AACvG,QAAI,WAAW;AACb,cAAQ,KAAK,sBAAsB,SAAS;AAAA,IAC9C;AACA,UAAM,YAAY,YAAY,aAAa;AAE3C,UAAM,YACJ,OAAO,6BAA6B,WAC/B,0BAA0B,WAAW,GAAG,IAAI,KAAK,MAAM,wBAAwB,IAAI,yBAAyB,MAAM,GAAG,EAAE,IAAI,CAAC,MAAc,EAAE,KAAA,CAAM,IACnJ,4BAA4B,CAAA;AAGlC,UAAM,cAAsC;AAAA,MAC1C,MAAM;AAAA,MACN,SAAS;AAAA,MACT,KAAK;AAAA,MACL,UAAU;AAAA,IAAA;AAEZ,UAAM,qBAAqB,YAAY,gBAAgB,KAAK;AAE5D,UAAM,EAAE,OAAO,gBAAgB,MAAM,cAAc,KAAK,SAAS,EAAE,OAAO;AAAA,MACxE;AAAA,QACE;AAAA,QACA;AAAA,QACA,kBAAkB;AAAA,QAClB;AAAA,QACA;AAAA,QACA,0BAA0B;AAAA,QAC1B,2BAA2B;AAAA,QAC3B,QAAQ;AAAA,MAAA;AAAA,IACV,CACD;AAED,QAAI,aAAa;AACf,cAAQ,MAAM,iBAAiB,WAAW;AAC1C,aAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,SAAS,qCAAqC,QAAQ,aAAa;AAAA,IACnG;AAEA,WAAO,IAAI,KAAK,EAAE,SAAS,yBAAyB,QAAQ,WAAW;AAAA,EACzE,SAAS,KAAK;AACZ,YAAQ,MAAM,GAAG;AACjB,WAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,SAAS,2BAA2B;AAAA,EACpE;AACF,CAAC;"}