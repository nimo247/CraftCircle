{"version":3,"file":"products-BNAd8aPh.js","sources":["../../server/routes/products.ts"],"sourcesContent":["import express from \"express\";\nimport { createClient } from \"@supabase/supabase-js\";\n\nconst router = express.Router();\n\nconst SUPABASE_URL = process.env.SUPABASE_URL || \"\";\nconst SUPABASE_SERVICE_ROLE = process.env.SUPABASE_SERVICE_ROLE || \"\";\n\nconst supabaseAdmin = createClient(SUPABASE_URL, SUPABASE_SERVICE_ROLE, {\n  auth: { persistSession: false },\n});\n\n// GET /api/products - public listing of active products, search, filtering and pagination\nrouter.get(\"/products\", async (req, res) => {\n  try {\n    const idsRaw = req.query.ids as string | undefined;\n    const q = ((req.query.q as string | undefined) || \"\").trim();\n    const category = ((req.query.category as string | undefined) || \"\").trim();\n    const page = Math.max(1, Number(req.query.page || 1));\n    const per_page = Math.max(\n      1,\n      Math.min(100, Number(req.query.per_page || 20)),\n    );\n\n    // If ids provided, return those exact items (no pagination needed)\n    if (idsRaw) {\n      const ids = idsRaw\n        .split(\",\")\n        .map((s) => s.trim())\n        .filter((s) => s && s !== \"null\" && s !== \"undefined\" && s !== \"0\");\n      if (ids.length === 0) return res.json({ products: [] });\n\n      const { data, error } = await supabaseAdmin\n        .from(\"products\")\n        .select(\n          \"id, title, price, images, vendor_email, vendor_id, status, stock, low_stock_threshold, categories\",\n        )\n        .in(\"id\", ids);\n\n      if (error)\n        return res\n          .status(500)\n          .json({ message: \"Failed to fetch products\", detail: error });\n\n      const toPublic = (p: any) => {\n        const encodePath = (pp: string) =>\n          (pp || \"\").split(\"/\").map(encodeURIComponent).join(\"/\");\n        const toPublicUrl = (key: string) => {\n          if (!key) return key;\n          const trimmed = String(key).trim();\n          if (!trimmed) return trimmed;\n          if (\n            /^https?:\\/\\//i.test(trimmed) ||\n            trimmed.includes(\"/storage/v1/object/public/\")\n          )\n            return trimmed;\n          const base = SUPABASE_URL.replace(/\\/$/, \"\");\n          return `${base}/storage/v1/object/public/product-images/${encodePath(trimmed)}`;\n        };\n        const imgs = p?.images;\n        let mapped: string[] | undefined = undefined;\n        if (Array.isArray(imgs)) mapped = imgs.map((i) => toPublicUrl(i));\n        else if (typeof imgs === \"string\" && imgs.trim()) {\n          try {\n            const parsed = JSON.parse(imgs);\n            if (Array.isArray(parsed))\n              mapped = parsed.map((i: any) => toPublicUrl(String(i)));\n          } catch (_) {\n            mapped = [toPublicUrl(imgs)];\n          }\n        }\n        return { ...p, images: mapped || [] };\n      };\n\n      return res.json({ products: (data || []).map(toPublic) });\n    }\n\n    // Build base query for active products\n    let baseQuery = supabaseAdmin\n      .from(\"products\")\n      .select(\n        \"id, title, price, images, vendor_email, vendor_id, status, stock, low_stock_threshold, categories\",\n        { count: \"exact\" },\n      )\n      .order(\"id\", { ascending: false })\n      .eq(\"status\", \"active\");\n\n    // Apply category filter if provided\n    if (category) {\n      // Prefer array contains (for text[] columns). If categories is a string this will be ignored by the DB.\n      try {\n        baseQuery = baseQuery.contains(\"categories\", [category]);\n      } catch (_) {\n        // fallback: no-op here; we avoid using ilike on potential text[] columns\n      }\n    }\n\n    // Apply full-text like search across title and vendor_email (avoid ilike on array columns)\n    if (q) {\n      // use case-insensitive partial match on title and vendor_email\n      baseQuery = baseQuery.or(`title.ilike.%${q}%,vendor_email.ilike.%${q}%`);\n    }\n\n    // Pagination using range\n    const from = (page - 1) * per_page;\n    const to = from + per_page - 1;\n\n    const { data, count, error } = await baseQuery.range(from, to);\n\n    if (error) {\n      console.error(\"Failed to fetch public products:\", error);\n      return res\n        .status(500)\n        .json({ message: \"Failed to fetch products\", detail: error });\n    }\n\n    // Map storage keys in images to public URLs so clients can directly display thumbnails.\n    const encodePath = (p: string) =>\n      (p || \"\").split(\"/\").map(encodeURIComponent).join(\"/\");\n    const toPublicUrl = (key: string) => {\n      if (!key) return key;\n      const trimmed = String(key).trim();\n      if (!trimmed) return trimmed;\n      if (\n        /^https?:\\/\\//i.test(trimmed) ||\n        trimmed.includes(\"/storage/v1/object/public/\")\n      )\n        return trimmed;\n      const base = SUPABASE_URL.replace(/\\/$/, \"\");\n      return `${base}/storage/v1/object/public/product-images/${encodePath(trimmed)}`;\n    };\n\n    const products = (data || []).map((p: any) => {\n      const imgs = p?.images;\n      let mapped: string[] | undefined = undefined;\n      if (Array.isArray(imgs)) mapped = imgs.map((i) => toPublicUrl(i));\n      else if (typeof imgs === \"string\" && imgs.trim()) {\n        try {\n          const parsed = JSON.parse(imgs);\n          if (Array.isArray(parsed))\n            mapped = parsed.map((i: any) => toPublicUrl(String(i)));\n        } catch (e) {\n          mapped = [toPublicUrl(imgs)];\n        }\n      }\n      return { ...p, images: mapped || [] };\n    });\n\n    const total = typeof count === \"number\" ? count : products.length + from;\n\n    return res.json({ products, total, page, per_page });\n  } catch (err) {\n    console.error(err);\n    return res.status(500).json({ message: \"Unexpected server error\" });\n  }\n});\n\nexport default router;\n"],"names":["express","data","error","encodePath","toPublicUrl"],"mappings":"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"}