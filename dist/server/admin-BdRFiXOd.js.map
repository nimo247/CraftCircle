{"version":3,"file":"admin-BdRFiXOd.js","sources":["../../server/routes/admin.ts"],"sourcesContent":["import express from \"express\";\nimport { createClient } from \"@supabase/supabase-js\";\n\nconst router = express.Router();\n\nconst SUPABASE_URL = process.env.SUPABASE_URL || \"\";\nconst SUPABASE_SERVICE_ROLE = process.env.SUPABASE_SERVICE_ROLE || \"\";\n\nif (!SUPABASE_URL || !SUPABASE_SERVICE_ROLE) {\n  console.warn(\"Supabase service role or URL not set. Admin vendor list route will fail if used.\");\n}\n\nconst supabaseAdmin = createClient(SUPABASE_URL, SUPABASE_SERVICE_ROLE, {\n  auth: { persistSession: false },\n});\n\n// GET /api/admin/vendors - returns list of vendors (admin use)\nrouter.get(\"/vendors\", async (req, res) => {\n  try {\n    const email = req.query.email as string | undefined;\n    let query = supabaseAdmin.from(\"vendors\").select(\"*\").order(\"id\", { ascending: false }).limit(200);\n    if (email) {\n      query = supabaseAdmin.from(\"vendors\").select(\"*\").eq(\"contact_email\", email).limit(1);\n    }\n    const { data, error } = await query;\n    if (error) {\n      console.error(\"Supabase fetch error:\", error);\n      return res.status(500).json({ message: \"Failed to fetch vendors\", detail: error });\n    }\n    return res.json({ vendors: data });\n  } catch (err) {\n    console.error(err);\n    return res.status(500).json({ message: \"Unexpected server error\" });\n  }\n});\n\n// POST /api/admin/vendors/verify - check vendor status by email\nrouter.post(\"/vendors/verify\", async (req, res) => {\n  try {\n    const { email } = req.body as { email?: string };\n    if (!email) return res.status(400).json({ message: \"email is required\" });\n    const { data, error } = await supabaseAdmin.from(\"vendors\").select(\"*\").eq(\"contact_email\", email).limit(1);\n    if (error) {\n      console.error(\"Supabase fetch error:\", error);\n      return res.status(500).json({ message: \"Failed to fetch vendor\", detail: error });\n    }\n    const vendor = (data && data.length > 0) ? data[0] : null;\n    return res.json({ vendor });\n  } catch (err) {\n    console.error(err);\n    return res.status(500).json({ message: \"Unexpected server error\" });\n  }\n});\n\n// PATCH /api/admin/vendors/:id - update vendor status\nrouter.patch(\"/vendors/:id\", async (req, res) => {\n  try {\n    const id = req.params.id;\n    console.log(\"ADMIN PATCH /vendors/:id called\", { id, method: req.method });\n    console.log(\"Headers:\", req.headers);\n    console.log(\"Query:\", req.query);\n    console.log(\"Raw body type:\", typeof req.body);\n    console.log(\"Body (truncated):\", JSON.stringify(req.body).slice(0, 2000));\n\n    // Support status from multiple sources and handle stringified bodies (some proxies send raw JSON strings)\n    let status: any = undefined;\n    // If body is a raw JSON string, try parsing\n    if (typeof req.body === \"string\") {\n      try {\n        const parsed = JSON.parse(req.body);\n        status = parsed?.status;\n      } catch (e) {\n        // ignore parse error\n      }\n    }\n    // Then check common places\n    status = status || (req.body && (req.body.status as any)) || (req.query && (req.query.status as any)) || (req.headers[\"x-status\"] as any);\n    if (typeof status === \"string\") status = status.trim();\n    if (!status) {\n      console.warn(\"Missing status on request\", { id });\n      return res.status(400).json({ message: \"status is required\", debug: { headers: req.headers, query: req.query, body: req.body } });\n    }\n    const { data, error } = await supabaseAdmin.from(\"vendors\").update({ status }).eq(\"id\", id).select();\n    if (error) {\n      console.error(\"Supabase update error:\", error);\n      return res.status(500).json({ message: \"Failed to update vendor\", detail: error });\n    }\n    return res.json({ vendor: data && data[0] });\n  } catch (err) {\n    console.error(err);\n    return res.status(500).json({ message: \"Unexpected server error\" });\n  }\n});\n\n// DELETE /api/admin/reviews/:id - delete review by id (admin only)\nrouter.delete(\"/reviews/:id\", async (req, res) => {\n  try {\n    const id = req.params.id;\n    if (!id) return res.status(400).json({ message: \"id is required\" });\n\n    // Admin key check\n    const ADMIN_KEY = process.env.ADMIN_KEY || \"NLRM1103\";\n    const provided = (req.headers[\"x-admin-key\"] as string) || \"\";\n    if (!provided || provided !== ADMIN_KEY) {\n      return res.status(403).json({ message: \"Forbidden\" });\n    }\n\n    const { data, error } = await supabaseAdmin.from(\"reviews\").delete().eq(\"id\", id).select();\n    if (error) {\n      console.error(\"Supabase delete error:\", error);\n      return res.status(500).json({ message: \"Failed to delete review\", detail: error });\n    }\n    return res.json({ deleted: data && data[0] ? data[0] : null });\n  } catch (err) {\n    console.error(err);\n    return res.status(500).json({ message: \"Unexpected server error\" });\n  }\n});\n\n// POST /api/admin/reviews/delete - bulk delete reviews by id (admin only)\nrouter.post(\"/reviews/delete\", async (req, res) => {\n  try {\n    const ids = (req.body && req.body.ids) || [];\n    if (!Array.isArray(ids) || ids.length === 0) return res.status(400).json({ message: \"ids array required\" });\n\n    const ADMIN_KEY = process.env.ADMIN_KEY || \"NLRM1103\";\n    const provided = (req.headers[\"x-admin-key\"] as string) || \"\";\n    if (!provided || provided !== ADMIN_KEY) {\n      return res.status(403).json({ message: \"Forbidden\" });\n    }\n\n    const { data, error } = await supabaseAdmin.from(\"reviews\").delete().in(\"id\", ids).select();\n    if (error) {\n      console.error(\"Supabase bulk delete error:\", error);\n      return res.status(500).json({ message: \"Failed to bulk delete reviews\", detail: error });\n    }\n\n    return res.json({ deleted: data || [] });\n  } catch (err) {\n    console.error(err);\n    return res.status(500).json({ message: \"Unexpected server error\" });\n  }\n});\n\n// POST /api/admin/vendors/:id/approve - set vendor status to approved\nrouter.post(\"/vendors/:id/approve\", async (req, res) => {\n  try {\n    const id = req.params.id;\n    console.log(\"ADMIN POST approve called\", { id, headers: req.headers, query: req.query });\n    if (!id) return res.status(400).json({ message: \"id is required\" });\n    const { data, error } = await supabaseAdmin.from(\"vendors\").update({ status: \"approved\" }).eq(\"id\", id).select();\n    if (error) {\n      console.error(\"Supabase update error (approve):\", error);\n      return res.status(500).json({ message: \"Failed to approve vendor\", detail: error });\n    }\n    return res.json({ vendor: data && data[0] });\n  } catch (err) {\n    console.error(err);\n    return res.status(500).json({ message: \"Unexpected server error\" });\n  }\n});\n\n// POST /api/admin/vendors/:id/reject - set vendor status to rejected\nrouter.post(\"/vendors/:id/reject\", async (req, res) => {\n  try {\n    const id = req.params.id;\n    console.log(\"ADMIN POST reject called\", { id, headers: req.headers, query: req.query });\n    if (!id) return res.status(400).json({ message: \"id is required\" });\n    const { data, error } = await supabaseAdmin.from(\"vendors\").update({ status: \"rejected\" }).eq(\"id\", id).select();\n    if (error) {\n      console.error(\"Supabase update error (reject):\", error);\n      return res.status(500).json({ message: \"Failed to reject vendor\", detail: error });\n    }\n    return res.json({ vendor: data && data[0] });\n  } catch (err) {\n    console.error(err);\n    return res.status(500).json({ message: \"Unexpected server error\" });\n  }\n});\n\nexport default router;\n"],"names":["express"],"mappings":"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"}